@using Entity.Identity.Entities
@model List<AuditLog>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.5/dist/bootstrap-table.min.css">

<script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.29.0/tableExport.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.5/dist/bootstrap-table.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.5/dist/bootstrap-table-locale-all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.5/dist/extensions/export/bootstrap-table-export.min.js"></script>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Reporte de Auditoría</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>


    <!-- Vendor CSS Files -->
    <link href="~/Admin/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/Admin/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="~/Admin/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="~/Admin/assets/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="~/Admin/assets/vendor/quill/quill.bubble.css" rel="stylesheet">
    <link href="~/Admin/assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="~/Admin/assets/vendor/simple-datatables/style.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="~/css/style.css" asp-append-version="true" rel="stylesheet">
    <link href="~/Admin/assets/scss/_card.scss" asp-append-version="true" rel="stylesheet">



    <style>
        #main {
            margin-top: 15px;
            padding: 30px 30px;
            transition: all 0.3s;
        }

        .dashboard .recent-sales {
            font-size: 16px;
        }
    </style>
</head>

<body>



    <main id="main" class="main">
        <div class="pagetitle">
            <h1>Auditoría</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                    <li class="breadcrumb-item active">Reporte de Auditoría</li>
                </ol>
            </nav>
        </div>

        <div style="margin-bottom: 15px; margin-left: 10px;">
            <button id="btnExportPdf" class="btn btn-primary">Exportar PDF</button>
        </div>

        <section class="section dashboard">
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <div class="row">     
                        <div class="col-12">
                            <div class="card recent-sales overflow-auto">
                                <div class="card-body">
                                    <h5 class="card-title">Reportes de Auditoría</h5>

                                    <table id="table" class="table table-borderless datatable">
                                        <thead>
                                            <tr>
                                                <th>Usuario</th>
                                                <th>Acción</th>
                                                <th>Entidad</th>
                                                <th>Cambios</th>
                                                <th>Entidad ID</th>
                                                <th>Fecha</th>

                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var log in Model)
                                            {
                                                <tr>
                                                    <td><span class="badge border-primary border-2 text-dark" style="font-size: 15px">@log.UserName | @log.UserEmail</span></td>
 
                                                    @if (log.Action == "Created")
                                                    {
                                                        <td><span class="badge bg-success">@log.Action</span></td>
                                                    }
                                                    else if (log.Action == "Modified")
                                                    {
                                                        <td><span class="badge bg-warning">@log.Action</span></td>
                                                    }
                                                    else
                                                    {
                                                        <td><span class="badge bg-danger">@log.Action</span></td>
                                                    }
                                                    <td><span class="badge border-primary border-2 text-dark" style="font-size: 15px">@log.EntityName</span></td>
                                                    <td>@log.Changes</td>
                                                    <td><a href="#">@log.EntityId</a></td>
                                                    <td><span class="badge border-primary border-2 text-dark" style="font-size: 15px">@log.Timestamp.ToString("dd/MM/yyyy HH:mm:ss")</span></td>
                                                </tr>
                                            }

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="row d-flex justify-content-center align-items-center" style="margin-top: 30px">
                            <div class="col-lg-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Acciones sobre Miembros</h5>
                                        <!-- Donut Chart -->
                                        <div id="donutChartAccionesMiembros" style="min-height: 400px;" class="echart"></div>
                                        <!-- End Donut Chart -->
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                </div>
        </section>

    </main>
  
    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

<script>
    $(document).ready(function () {
        $('.datatable').DataTable({
            "order": [[3, "asc"]], // Primera ordenación ascendente en la columna "Acción"
            "columnDefs": [
                { "orderable": true, "targets": 3 } // Asegurar que la columna sea ordenable
            ]
        });
    });


        document.getElementById("btnExportPdf").addEventListener("click", function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4");

        // Fecha y hora actual
        const fechaActual = new Date().toLocaleDateString();
        const horaActual = new Date().toLocaleTimeString();

        // **Título**
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text("Reporte de Auditoria (Entidades)", 105, 15, { align: "center" });

        // **Línea decorativa**
        doc.setDrawColor(0, 0, 0);
        doc.line(14, 20, 196, 20);

        // **Fecha de exportación**
        doc.setFontSize(10);
        doc.setFont("helvetica", "italic");
        doc.setTextColor(100, 100, 100);
        doc.text(`Fecha de exportación: ${fechaActual} - ${horaActual}`, 14, 26);

        let startY = 35; // Posición inicial

        // **Tabla: Listado de Auditoria**
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Listado de Auditoria", 14, startY);

        // **Obtener datos de la tabla HTML**
        const table = document.getElementById("table");
        if (!table) {
            console.error("No se encontró la tabla con ID 'table'.");
            return;
        }

        // Obtener encabezados
        const headers = [];
        const headerCells = table.querySelectorAll("thead tr th");
        headerCells.forEach(th => {
            if (th.innerText.trim() !== "Acciones") {  // Excluir la columna "Acciones"
                headers.push(th.innerText.trim());
            }
        });

        // Obtener datos de las filas
        const data = [];
        const rows = table.querySelectorAll("tbody tr");
        rows.forEach(row => {
            const rowData = [];
            row.querySelectorAll("td").forEach((td, index) => {
                // Excluir la columna "Acciones"
                if (headerCells[index] && headerCells[index].innerText.trim() !== "Acciones") {
                    rowData.push(td.innerText.trim());
                }
            });
            data.push(rowData);
        });

        // Verificar si hay datos
        if (data.length === 0) {
            console.error("No hay datos en la tabla para exportar.");
            return;
        }

        // **Generar tabla en el PDF**
        doc.autoTable({
            startY: startY + 5,
            head: [headers],
            body: data,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 2, valign: 'middle' },
            headStyles: { fillColor: [52, 73, 94], textColor: [255, 255, 255] },
            alternateRowStyles: { fillColor: [240, 240, 240] },
            margin: { top: 25, left: 10, right: 10 }
        });

        // **Pie de página con número de páginas**
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(`Página ${i} de ${pageCount}`, 105, 287, { align: "center" });
        }

        // **Descargar el PDF**
        doc.save(`ListaAuditoria_${fechaActual}.pdf`);
    });

           document.addEventListener("DOMContentLoaded", function () {
        var chartDom = document.getElementById('donutChartAccionesMiembros');
        if (chartDom) {  // Verifica que el contenedor existe
            var myChart = echarts.init(chartDom);

            // Obtén los datos de las acciones de miembros desde ViewBag
            var acciones = @Html.Raw(Json.Serialize(ViewBag.AccionesMiembros));

            // Prepara los datos para el gráfico
            var chartData = [
                { value: acciones["Created"], name: 'Creado' },
                { value: acciones["Modified"], name: 'Modificado' },
                { value: acciones["Deleted"], name: 'Eliminado' }
            ];

            var option = {
                tooltip: { trigger: 'item' },
                legend: { orient: 'vertical', left: 'left' },
                series: [{
                    name: 'Acciones',
                    type: 'pie',
                    radius: '50%',
                    data: chartData
                }]
            };

            myChart.setOption(option);

            // Manejar el redimensionamiento
            window.addEventListener('resize', function () {
                myChart.resize();
            });
        } else {
            console.error("No se encontró el contenedor del gráfico.");
        }
    });


</script>
